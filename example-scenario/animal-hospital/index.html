<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>동물병원 진료시스템 - msa-ez-kor.github</title><meta name="gridsome:hash" content="06bf9166c909e409f7f572bd0df19f73dd3dffcb"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.13"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" name="google-site-verification" content="oB0o3U6khwkYrh-W15uMb7kob6NYYAqjEVeXdPsVjyE"><meta data-vue-tag="ssr" name="robots" content="Remote Event Storming,EventStorming,Microservices,이벤트스토밍,마이크로서비스,MSA,CNA,클라우드 네이티브,Code generator,intromsaez,쿠버네티스, kubernetes tool, spring-boot, 스프링부트, 개발툴, development tool, 교육, 강의, lecture, course"><meta data-vue-tag="ssr" data-key="og:url" name="og:url" content="undefined/templates-language/springboot-java-template/"><meta data-vue-tag="ssr" name="description" content="undefined"><meta data-vue-tag="ssr" data-key="og:title" name="og:title" content="동물병원 진료시스템"><meta data-vue-tag="ssr" data-key="twitter:title" name="twitter:title" content="동물병원 진료시스템"><meta data-vue-tag="ssr" data-key="og:description" name="og:description" content="undefined"><meta data-vue-tag="ssr" data-key="twitter:description" name="twitter:description" content="undefined"><meta data-vue-tag="ssr" data-key="og:type" name="og:type" content="website"><meta data-vue-tag="ssr" data-key="twitter:card" name="twitter:card" content="summary_large_image"><meta data-vue-tag="ssr" data-key="og:image" name="og:image" content="undefined/logo.jpg"><meta data-vue-tag="ssr" data-key="twitter:image" name="twitter:image" content="undefined/logo.jpg"><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.f0886199c685a75a52fccefb5e72c094.png"><link rel="preload" href="/assets/css/0.styles.0e3e700a.css" as="style"><link rel="preload" href="/assets/js/app.cced8b4b.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--markdown-page-vue.edfc8e12.js" as="script"><link rel="prefetch" href="/assets/js/page--src--pages--404-vue.d3f954b7.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.b69aa1c8.js"><link rel="prefetch" href="/assets/js/search.e1975d39.js"><link rel="stylesheet" href="/assets/css/0.styles.0e3e700a.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="font-sans antialiased text-ui-typo bg-ui-background"><div class="flex flex-col justify-start min-h-screen"><header class="sticky top-0 z-10 w-full border-b bg-ui-background border-ui-border"><div class="py-2 border-t-2 border-ui-primary"><div class="container"><div class="flex items-center justify-between -mx-2 sm:-mx-4"><div class="flex flex-col items-center px-2 mr-auto sm:px-4 sm:flex-row"><a href="/" title="Home" class="flex items-center text-ui-primary active"><svg width="40" height="40" x="0.0" y="0.0" viewBox="0 0 48 48" class="text-ui-primary"><path fill="currentColor" fill-rule="nonzero" d="M24 .21L.21 24 24 47.79 47.79 24 24 .21zM5.82 24L24 5.82l7.69 7.69-2.8 2.8L24 11.43 11.43 24l4.88 4.89-2.8 2.8L5.82 24zm25.15 0L24 30.97 17.03 24 24 17.03 30.97 24zM16.31 34.49l2.8-2.8L24 36.57 36.57 24l-4.89-4.89 2.8-2.8 7.7 7.69L24 42.18l-7.69-7.69z"></path></svg><span class="hidden ml-2 text-xl font-black tracking-tighter uppercase sm:block">
            msa-ez-kor.github
          </span></a><div class="hidden ml-2 mr-5 sm:block sm:ml-8"><a href="/started/" class="block p-1 font-medium nav-link text-ui-typo hover:text-ui-primary">
            Docs
          </a></div></div><div class="w-full px-2 sm:px-4 max-w-screen-xs"><!----></div><div class="flex items-center justify-end px-2 sm:px-4"><!----><!----><!----><button aria-label="Toggle Darkmode" title="Toggle Darkmode" class="ml-2 sm:ml-8"><svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></div></div></div></div></header><main class="container relative flex flex-wrap justify-start flex-1 w-full bg-ui-background"><!----><div class="w-full pb-24"><div class="flex flex-wrap items-start justify-start"><div class="order-2 w-full md:w-1/3 sm:pl-4 md:pl-6 lg:pl-8 sticky" style="top:4rem;"><div class="mt-8 sm:pl-4 md:pl-6 md:pt-12 lg:pl-8 sm:pb-16 sm:border-l border-ui-border md:mt-0"><h3 class="pt-0 mt-0 text-sm tracking-wide uppercase border-none">On this page</h3><div><ul><li class="font-semibold depth-2"><a href="/example-scenario/animal-hospital/#서비스-시나리오" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          서비스 시나리오
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#분석설계" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          분석/설계
        </a></li><li class="depth-3"><a href="/example-scenario/animal-hospital/#·-헥사고날-아키텍처-다이어그램-도출" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          · 헥사고날 아키텍처 다이어그램 도출
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#구현" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          구현
        </a></li><li class="depth-3"><a href="/example-scenario/animal-hospital/#·-ddd-의-적용" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          · DDD 의 적용
        </a></li><li class="depth-3"><a href="/example-scenario/animal-hospital/#·-동기식-호출과-fallback-처리" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          · 동기식 호출과 Fallback 처리
        </a></li><li class="depth-3"><a href="/example-scenario/animal-hospital/#·-클러스터-적용-후-rest-api-의-테스트" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          · 클러스터 적용 후 REST API 의 테스트
        </a></li><li class="depth-3"><a href="/example-scenario/animal-hospital/#·-비동기식-호출과-eventual-consistency" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          · 비동기식 호출과 Eventual Consistency
        </a></li><li class="depth-3"><a href="/example-scenario/animal-hospital/#·-api-게이트웨이" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          · API 게이트웨이
        </a></li><li class="depth-3"><a href="/example-scenario/animal-hospital/#·-oauth-인증-적용" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          · Oauth 인증 적용.
        </a></li><li class="border-t border-dashed border-ui-border pt-2 mt-2 font-semibold depth-2"><a href="/example-scenario/animal-hospital/#운영" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          운영
        </a></li><li class="depth-3"><a href="/example-scenario/animal-hospital/#·-cicd-설정" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          · CI/CD 설정
        </a></li><li class="depth-3"><a href="/example-scenario/animal-hospital/#·-동기식-호출--서킷-브레이킹--장애격리" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          · 동기식 호출 / 서킷 브레이킹 / 장애격리
        </a></li><li class="depth-3"><a href="/example-scenario/animal-hospital/#·-오토스케일-아웃" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          · 오토스케일 아웃
        </a></li><li class="depth-3"><a href="/example-scenario/animal-hospital/#·-무정지-재배포" class="relative flex items-center py-1 text-sm transition transform hover:translate-x-1 pl-2"><span class="absolute w-2 h-2 -ml-3 rounded-full opacity-0 bg-ui-primary transition transform scale-0 origin-center"></span>
          · 무정지 재배포
        </a></li></ul></div></div></div><div class="order-1 w-full md:w-2/3"><div class="content"><h1 id="동물병원-진료시스템"><a href="#%EB%8F%99%EB%AC%BC%EB%B3%91%EC%9B%90-%EC%A7%84%EB%A3%8C%EC%8B%9C%EC%8A%A4%ED%85%9C" aria-hidden="true"><span class="icon icon-link"></span></a>동물병원 진료시스템</h1>
<p>출처 원본: <a href="https://github.com/msa-ez/example-animal-hospital" target="_blank" rel="noopener noreferrer">https://github.com/msa-ez/example-animal-hospital</a></p>
<h3>2조 과제 - 동물병원 진료시스템 구축</h3>
<p>이 시스템은 MSA/DDD/Event Storming/EDA 를 포괄하는 분석/설계/구현/운영 전단계를 커버하도록 구성하였습니다.
이 시스템은 클라우드 네이티브 애플리케이션 Final Project 수행 테스트를 통과하기 위한 답안을 포함합니다.</p>
<h2 id="서비스-시나리오"><a href="#%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%8B%9C%EB%82%98%EB%A6%AC%EC%98%A4" aria-hidden="true"><span class="icon icon-link"></span></a>서비스 시나리오</h2>
<p><strong>기능적 요구사항</strong><br>
1. 고객은 동물병원에 예약 및 예약 취소 변경을 한다.<br>
2. 예약이 완료된 고객은 진료를 받는다. <br>
3. 수납은 고객에게 진료비를 청구한다.<br>
4. 고객이 치료비를 지불한다.<br>
5. 예약이 변경/취소되면 진료/처방이 변경/취소된다.<br>
6. 예약상태가 바뀔 때 마다 카톡으로 알림을 보낸다.<br>
7. 고객은 Lookup 시스템에서 예약 상태를 조회할 수 있다.<br></p>
<p><strong>비기능적 요구사항</strong><br>
1. 트랜잭션</p>
<ul>
<li>
<ol>
<li>진료가 불가능 할 때는 예약이 불가능해야 한다. Sync 호출</li>
</ol>
</li>
</ul>
<ol start="2">
<li>장애격리</li>
</ol>
<ul>
<li>
<ol>
<li>예약/진료 시스템(core)만 온전하면 시스템은 정상적으로 수행되어야 한다.  Async (event-driven), Eventual Consistency</li>
</ol>
</li>
<li>
<ol start="2">
<li>문자 알림, 치료비 수납 시스템에 장애가 생겨도 예약/진료 (core) 시스템은 정상적으로 작동한다.</li>
</ol>
</li>
<li>
<ol start="3">
<li>진료시스템이 과중되면 예약을 잠시후에 하도록 유도한다.  Circuit breaker, fallback</li>
</ol>
</li>
</ul>
<ol start="3">
<li>성능</li>
</ol>
<ul>
<li>
<ol>
<li>고객이 예약/진료/치료 결과를 시스템에서 확인할 수 있어야 한다.(Lookup 시스템으로 구현, CQRS)</li>
</ol>
</li>
<li>
<ol start="2">
<li>알림 시스템을 통해 예약/예약취소/예약변경 내용을 문자로 알림을 줄 수 있어야 한다. (Event driven)</li>
</ol>
</li>
</ul>
<h2 id="분석설계"><a href="#%EB%B6%84%EC%84%9D%EC%84%A4%EA%B3%84" aria-hidden="true"><span class="icon icon-link"></span></a>분석/설계</h2>
<p><strong><a href="http://msaez.io/#/storming/0vtSW2vBLoZTFiAsgdwS6H7ODs33/2dac041f4e652d598a042694dfa26b20" target="_blank" rel="noopener noreferrer">MSAEz 로 모델링한 이벤트스토밍 결과</a></strong></p>
<ul>
<li>Core Domain : 예약 (Reservation) 및 진료 (Diagnosis) 도메인</li>
<li>Supporting Domain : Lookup(CQRS) 도메인</li>
<li>General Domain : 알림(notice) 시스템.</li>
</ul>
<h3 id="·-헥사고날-아키텍처-다이어그램-도출"><a href="#%C2%B7-%ED%97%A5%EC%82%AC%EA%B3%A0%EB%82%A0-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98-%EB%8B%A4%EC%9D%B4%EC%96%B4%EA%B7%B8%EB%9E%A8-%EB%8F%84%EC%B6%9C" aria-hidden="true"><span class="icon icon-link"></span></a>· 헥사고날 아키텍처 다이어그램 도출</h3>
<p><img src="https://user-images.githubusercontent.com/38850007/79833622-aad4a200-83e6-11ea-80f1-6eb9a59503af.png" alt="image"></p>
<h2 id="구현"><a href="#%EA%B5%AC%ED%98%84" aria-hidden="true"><span class="icon icon-link"></span></a>구현</h2>
<p>분석/설계 단계에서 도출된 헥사고날 아키텍처에 따라, 각 BC별로 대변되는 마이크로 서비스들을 스프링부트로 구현하였다. 구현한 각 서비스를 로컬에서 실행하는 방법은 아래와 같다 (각자의 포트넘버는 8081 ~ 808n 이다)</p>
<p>동물병원 예약/진료 시스템은 아래의 7가지 마이크로 서비스로 구성되어 있다.</p>
<ol>
<li>게이트 웨이: <a href="https://github.com/AnimalHospital2/gateway.git" target="_blank" rel="noopener noreferrer">https://github.com/AnimalHospital2/gateway.git</a></li>
<li>Oauth 시스템: <a href="https://github.com/AnimalHospital2/ouath.git" target="_blank" rel="noopener noreferrer">https://github.com/AnimalHospital2/ouath.git</a></li>
<li>예약 시스템: <a href="https://github.com/AnimalHospital2/reservation.git" target="_blank" rel="noopener noreferrer">https://github.com/AnimalHospital2/reservation.git</a></li>
<li>진료 시스템: <a href="https://github.com/AnimalHospital2/diagnosis.git" target="_blank" rel="noopener noreferrer">https://github.com/AnimalHospital2/diagnosis.git</a></li>
<li>수납 시스템: <a href="https://github.com/AnimalHospital2/acceptance.git" target="_blank" rel="noopener noreferrer">https://github.com/AnimalHospital2/acceptance.git</a></li>
<li>알림 시스템: <a href="https://github.com/AnimalHospital2/notice.git" target="_blank" rel="noopener noreferrer">https://github.com/AnimalHospital2/notice.git</a></li>
</ol>
<ul>
<li>게이트웨이 시스템은 수업시간에 이용한 예제를 프로젝트에 맞게 설정을 변경하였다. </li>
<li>Oauth 시스템은 수업시간에 이용한 예제를 그대로 활용하였다.</li>
</ul>
<p>모든 시스템은 Spring Boot로 구현하였고 <code>mvn spring-boot:run</code> 명령어로 실행할 수 있다.</p>
<h3 id="·-ddd-의-적용"><a href="#%C2%B7-ddd-%EC%9D%98-%EC%A0%81%EC%9A%A9" aria-hidden="true"><span class="icon icon-link"></span></a>· DDD 의 적용</h3>
<ul>
<li>각 서비스내에 도출된 핵심 Aggregate Root 객체를 Entity 로 선언하였다: (예시는 예약 시스템의 Reservation.class). 이때 가능한 현업에서 사용하는 언어 (유비쿼터스 랭귀지)를 그대로 사용하려고 노력했다.</li>
</ul>
<pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>reservation</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>reservation<span class="token punctuation">.</span>external</span><span class="token punctuation">.</span><span class="token class-name">MedicalRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>reservation<span class="token punctuation">.</span>external</span><span class="token punctuation">.</span><span class="token class-name">MedicalRecordService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core</span><span class="token punctuation">.</span><span class="token class-name">JsonProcessingException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind</span><span class="token punctuation">.</span><span class="token class-name">ObjectMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>stream<span class="token punctuation">.</span>messaging</span><span class="token punctuation">.</span><span class="token class-name">Processor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging</span><span class="token punctuation">.</span><span class="token class-name">MessageChannel</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging</span><span class="token punctuation">.</span><span class="token class-name">MessageHeaders</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span>support</span><span class="token punctuation">.</span><span class="token class-name">MessageBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">MimeTypeUtils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>persistence</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"RESERVATION"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Reservation</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> reservatorName<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> reservationDate<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> phoneNumber<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostPersist</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publishReservationReservedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">MedicalRecord</span> medicalRecord <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MedicalRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        medicalRecord<span class="token punctuation">.</span><span class="token function">setReservationId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        medicalRecord<span class="token punctuation">.</span><span class="token function">setDoctor</span><span class="token punctuation">(</span><span class="token string">"Brad pitt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        medicalRecord<span class="token punctuation">.</span><span class="token function">setMedicalOpinion</span><span class="token punctuation">(</span><span class="token string">"별 이상 없습니다."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        medicalRecord<span class="token punctuation">.</span><span class="token function">setTreatment</span><span class="token punctuation">(</span><span class="token string">"그냥 집에서 푹 쉬면 나을 것입니다."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ReservationApplication</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">MedicalRecordService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">diagnosis</span><span class="token punctuation">(</span>medicalRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// Reserved 이벤트 발생</span>

        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            json <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReservationReserved</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"JSON format exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Processor</span> processor <span class="token operator">=</span> <span class="token class-name">ReservationApplication</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MessageChannel</span> outputChannel <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        outputChannel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MessageBuilder</span>
                <span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">MessageHeaders</span><span class="token punctuation">.</span>CONTENT_TYPE<span class="token punctuation">,</span> <span class="token class-name">MimeTypeUtils</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostUpdate</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publishReservationChangedEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            json <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReservationChanged</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"JSON format exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Processor</span> processor <span class="token operator">=</span> <span class="token class-name">ReservationApplication</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MessageChannel</span> outputChannel <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        outputChannel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MessageBuilder</span>
                <span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">MessageHeaders</span><span class="token punctuation">.</span>CONTENT_TYPE<span class="token punctuation">,</span> <span class="token class-name">MimeTypeUtils</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PostRemove</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publishReservationCanceledEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            json <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReservationCanceled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"JSON format exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Processor</span> processor <span class="token operator">=</span> <span class="token class-name">ReservationApplication</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MessageChannel</span> outputChannel <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        outputChannel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">MessageBuilder</span>
                <span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">MessageHeaders</span><span class="token punctuation">.</span>CONTENT_TYPE<span class="token punctuation">,</span> <span class="token class-name">MimeTypeUtils</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getReservatorName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> reservatorName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReservatorName</span><span class="token punctuation">(</span><span class="token class-name">String</span> reservatorName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reservatorName <span class="token operator">=</span> reservatorName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getReservationDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> reservationDate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReservationDate</span><span class="token punctuation">(</span><span class="token class-name">String</span> reservationDate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reservationDate <span class="token operator">=</span> reservationDate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPhoneNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> phoneNumber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPhoneNumber</span><span class="token punctuation">(</span><span class="token class-name">String</span> phoneNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>phoneNumber <span class="token operator">=</span> phoneNumber<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<ul>
<li>Entity Pattern 과 Repository Pattern 을 적용하여 JPA 를 통하여 다양한 데이터소스 유형 (RDB or NoSQL) 에 대한 별도의 처리가 없도록 데이터 접근 어댑터를 자동 생성하기 위하여 Spring Data REST 의 RestRepository 를 적용하였다.
RDB로는 H2를 사용하였다. </li>
</ul>
<pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>reservation</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>repository</span><span class="token punctuation">.</span><span class="token class-name">CrudRepository</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ReservationRepository</span> <span class="token keyword">extends</span> <span class="token class-name">CrudRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Reservation</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<ul>
<li>적용 후 REST API 의 테스트</li>
</ul>
<p>주의!!! reservation 서비스에는 FeignClient가 적용되어 있다. 여기에 diagnosis 시스템의 api 주소가 하드코딩되어 있어 로컬 테스트 환경과
Cloud 테스트 환경에서는 그 값을 달리하여 테스트하여야 한다.</p>
<p>package com.example.reservation.external.MedicalRecordService의 내용을 테스트 환경에 따라 변경해준다.;</p>
<ul>
<li>Local 환경 테스트시 </li>
</ul>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"diagnosis"</span><span class="token punctuation">,</span> url <span class="token operator">=</span> <span class="token string">"http://localhost:8083"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MedicalRecordService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span> path <span class="token operator">=</span> <span class="token string">"/medicalRecords"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">diagnosis</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MedicalRecord</span> medicalRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<ul>
<li>Cloud 환경 테스트시</li>
</ul>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"diagnosis"</span><span class="token punctuation">,</span> url <span class="token operator">=</span> <span class="token string">"http://diagnosis:8080"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MedicalRecordService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span> path <span class="token operator">=</span> <span class="token string">"/medicalRecords"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">diagnosis</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MedicalRecord</span> medicalRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>아래의 명령어는 httpie 프로그램을 사용하여 입력한다.</p>
<pre class="language-text"><code class="language-text"># 예약 서비스의 예약
http post localhost:8081/reservations reservatorName=&quot;Jackson&quot; reservationDate=&quot;2020-04-30&quot; phoneNumber=&quot;010-1234-5678&quot;

# 예약 서비스의 예약 취소
http delete localhost:8081/reservations/1

# 예약 서비스의 예약 변경
http patch localhost:8081/reservations/1 reservationDate=&quot;2020-05-01&quot;

# 진료 기록 리스트 확인
http localhost:8083/medicalRecords</code></pre>
<h3 id="·-동기식-호출과-fallback-처리"><a href="#%C2%B7-%EB%8F%99%EA%B8%B0%EC%8B%9D-%ED%98%B8%EC%B6%9C%EA%B3%BC-fallback-%EC%B2%98%EB%A6%AC" aria-hidden="true"><span class="icon icon-link"></span></a>· 동기식 호출과 Fallback 처리</h3>
<p>분석단계에서의 조건 중 하나로 예약(reservation)->진료(diagnosis) 간의 호출은 동기식 일관성을 유지하는 트랜잭션으로 처리하기로 하였다. 호출 프로토콜은 이미 앞서 Rest Repository 에 의해 노출되어있는 REST 서비스를 FeignClient 를 이용하여 호출하도록 한다. </p>
<ul>
<li>진료서비스를 호출하기 위하여 FeignClient를 이용하여 Service 대행 인터페이스 (Proxy) 를 구현 </li>
</ul>
<pre class="language-text"><code class="language-text"># (app) 결제이력Service.java
package com.example.reservation.external;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

@FeignClient(name = &quot;diagnosis&quot;, url = &quot;http://diagnosis:8080&quot;)
  public interface MedicalRecordService {

    @RequestMapping(method = RequestMethod.POST, path = &quot;/medicalRecords&quot;)
    public void diagnosis(@RequestBody MedicalRecord medicalRecord);
}</code></pre>
<ul>
<li>예약완료 직후(@PostPersist) 진단을 요청하도록 처리</li>
</ul>
<pre class="language-text"><code class="language-text"># Reservation.java (Entity)
    @PostPersist
       public void publishReservationReservedEvent() {
   
           // 예약이 발생하면 바로 진료 진행.
           MedicalRecord medicalRecord = new MedicalRecord();
   
           medicalRecord.setReservationId(this.getId());
           medicalRecord.setDoctor(&quot;Brad pitt&quot;);
           medicalRecord.setMedicalOpinion(&quot;별 이상 없습니다.&quot;);
           medicalRecord.setTreatment(&quot;그냥 집에서 푹 쉬면 나을 것입니다.&quot;);
   
           ReservationApplication.applicationContext.getBean(MedicalRecordService.class).diagnosis(medicalRecord);
   
   
           // Reserved 이벤트 발생
           ObjectMapper objectMapper = new ObjectMapper();
           String json = null;
   
           try {
               json = objectMapper.writeValueAsString(new ReservationReserved(this));
           } catch (JsonProcessingException e) {
               throw new RuntimeException(&quot;JSON format exception&quot;, e);
           }
   
           Processor processor = ReservationApplication.applicationContext.getBean(Processor.class);
           MessageChannel outputChannel = processor.output();
   
           outputChannel.send(MessageBuilder
                   .withPayload(json)
                   .setHeader(MessageHeaders.CONTENT_TYPE, MimeTypeUtils.APPLICATION_JSON)
                   .build());</code></pre>
<ul>
<li>동기식 호출에서는 호출 시간에 따른 타임 커플링이 발생하며, 진단 시스템이 장애가 나면 예약도 못받는다는 것을 확인.(비즈상 무리가 있음..) </li>
</ul>
<pre class="language-text"><code class="language-text"># 진료 (diagnosis) 서비스를 잠시 내려놓음 (ctrl+c)

# 예약 처리
http post localhost:8081/reservations reservatorName=&quot;Jackson&quot; reservationDate=&quot;2020-04-30&quot; phoneNumber=&quot;010-1234-5678&quot; #Fail

#진료 서비스 재기동
cd diagnosis
mvn spring-boot:run

#예약처리
http post localhost:8081/reservations reservatorName=&quot;Jackson&quot; reservationDate=&quot;2020-04-30&quot; phoneNumber=&quot;010-1234-5678&quot; #Success</code></pre>
<h3 id="·-클러스터-적용-후-rest-api-의-테스트"><a href="#%C2%B7-%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EC%A0%81%EC%9A%A9-%ED%9B%84-rest-api-%EC%9D%98-%ED%85%8C%EC%8A%A4%ED%8A%B8" aria-hidden="true"><span class="icon icon-link"></span></a>· 클러스터 적용 후 REST API 의 테스트</h3>
<ul>
<li><a href="http://52.231.118.148:8080/medicalRecords/" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080/medicalRecords/</a>     		//diagnosis 조회</li>
<li><a href="http://52.231.118.148:8080/reservations/" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080/reservations/</a>       		//reservation 조회 </li>
<li><a href="http://52.231.118.148:8080/reservations" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080/reservations</a> reservatorName="pdc" reservationDate="202002" phoneNumber="0103701" //reservation 요청 </li>
<li>Delete <a href="http://52.231.118.148:8080/reservations/1" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080/reservations/1</a> 	//reservation Cancel  Sample</li>
<li><a href="http://52.231.118.148:8080/reservationStats/" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080/reservationStats/</a>   	  //lookup  조회</li>
<li><a href="http://52.231.118.148:8080/financialManagements/" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080/financialManagements/</a> 	//acceptance 조회</li>
</ul>
<ul>
<li>또한 과도한 예약 요청시에 서비스 장애가 도미노 처럼 벌어질 수 있다. (서킷브레이커, 폴백 처리는 운영단계에서 설명한다.)</li>
</ul>
<h3 id="·-비동기식-호출과-eventual-consistency"><a href="#%C2%B7-%EB%B9%84%EB%8F%99%EA%B8%B0%EC%8B%9D-%ED%98%B8%EC%B6%9C%EA%B3%BC-eventual-consistency" aria-hidden="true"><span class="icon icon-link"></span></a>· 비동기식 호출과 Eventual Consistency</h3>
<p>진료가 이루어진 후에 수납시스템으로 이를 알려주는 행위는 동기식이 아니라 비 동기식으로 처리하여 수납 시스템의 처리를 위하여 예약/진료 시스템이 블로킹 되지 않아도록 처리한다.</p>
<ul>
<li>이를 위하여 진료이력을 남긴 후에 곧바로 진료가 이루어졌다는 이벤트를를 카프카로 송출한다(Publish)</li>
</ul>
<pre class="language-text"><code class="language-text">// package Animal.Hospital.MedicalRecord;

    @PrePersist
    public void onPrePersist(){
        Treated treated = new Treated();
        BeanUtils.copyProperties(this, treated);
        treated.publish();
    }</code></pre>
<ul>
<li>수납 서비스에서는 진료완료 이벤트에 대해서 이를 수신하여 자신의 정책을 처리하도록 PolicyHandler 를 구현한다:</li>
</ul>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">FinancialManagementRepository</span> financialManagementRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">TreatedEvent</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Payload</span> <span class="token class-name">Treated</span> treated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>treated<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"Treated"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"수납요청 되었습니다."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">FinancialManagement</span> financialManagement <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinancialManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            financialManagement<span class="token punctuation">.</span><span class="token function">setReservationId</span><span class="token punctuation">(</span>treated<span class="token punctuation">.</span><span class="token function">getReservationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            financialManagement<span class="token punctuation">.</span><span class="token function">setFee</span><span class="token punctuation">(</span><span class="token number">10000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            financialManagementRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>financialManagement<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>알림 시스템은 실제로 문자를 보낼 수는 없으므로, 예약/변경/취소 이벤트에 대해서 System.out.println 처리 하였다.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>notice</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReservationReservedEvent</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Payload</span> <span class="token class-name">ReservationReserved</span> reservationReserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>reservationReserved<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"ReservationReserved"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"예약 되었습니다."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReservationChangedEvent</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Payload</span> <span class="token class-name">ReservationChanged</span> reservationChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>reservationChanged<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"ReservationChanged"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"예약 변경 되었습니다."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@StreamListener</span><span class="token punctuation">(</span><span class="token class-name">Processor</span><span class="token punctuation">.</span>INPUT<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReservationCanceledEvent</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Payload</span> <span class="token class-name">ReservationCanceled</span> reservationCanceled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>reservationCanceled<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"ReservationCanceled"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"예약 취소 되었습니다."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>수납, Lookup(CQRS) 시스템은 예약/진료와 완전히 분리되어있으며, 이벤트 수신에 따라 처리되기 때문에, 수납/Lookup 시스템이 유지보수로 인해 잠시 내려간 상태라도 예약/진료를 하는데 문제가 없다:</p>
<pre class="language-text"><code class="language-text"># 수납 서비스 (acceptance) 를 잠시 내려놓음 (ctrl+c)

#예약처리
http post localhost:8081/reservations reservatorName=&quot;Jackson&quot; reservationDate=&quot;2020-04-30&quot; phoneNumber=&quot;010-1234-5678&quot; #Success

#예약상태 확인
http localhost:8081/reservations     # 예약 추가 된 것 확인

#수납 서비스 기동
cd acceptance
mvn spring-boot:run

#수납상태 확인
http localhost:8085/financialManagements     # 모든 예약-진료에 대해서 요금이 청구되엇음을 확인.</code></pre>
<h3 id="·-api-게이트웨이"><a href="#%C2%B7-api-%EA%B2%8C%EC%9D%B4%ED%8A%B8%EC%9B%A8%EC%9D%B4" aria-hidden="true"><span class="icon icon-link"></span></a>· API 게이트웨이</h3>
<ul>
<li>Local 테스트 환경에서는 localhost:8080에서 Gateway API 가 작동.</li>
<li>Cloud 환경에서는 <a href="http://52.231.118.148:8080" target="_blank" rel="noopener noreferrer">http://52.231.118.148:8080</a> 에서 Gateway API가 작동.</li>
<li>application.yml 파일에 프로파일 별로 Gateway 설정.</li>
</ul>
<h3> Gateway 설정 파일</h3>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8088</span>

<span class="token punctuation">---</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> default
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token key atrule">resourceserver</span><span class="token punctuation">:</span>
        <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
          <span class="token key atrule">jwk-set-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8088/.well<span class="token punctuation">-</span>known/jwks.json
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> reservation
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8081</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/reservations/**
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> diagnosis
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8083</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/medicalRecords/**
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> lookup
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8084</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/reservationStats/**
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> acceptance
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8085</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/financialManagements/**
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> oauth
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8090</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/oauth/**
      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span>
        <span class="token key atrule">corsConfigurations</span><span class="token punctuation">:</span>
          '<span class="token punctuation">[</span>/**<span class="token punctuation">]</span>'<span class="token punctuation">:</span>
            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"*"</span>
            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"*"</span>
            <span class="token key atrule">allowedHeaders</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"*"</span>
            <span class="token key atrule">allowCredentials</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>


<span class="token punctuation">---</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span> docker
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token key atrule">resourceserver</span><span class="token punctuation">:</span>
        <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
          <span class="token key atrule">jwk-set-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8080/.well<span class="token punctuation">-</span>known/jwks.json
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> reservation
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//reservation<span class="token punctuation">:</span><span class="token number">8080</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/reservations/**
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> diagnosis
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//diagnosis<span class="token punctuation">:</span><span class="token number">8080</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/medicalRecords/**
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> lookup
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//lookup<span class="token punctuation">:</span><span class="token number">8080</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/reservationStats/**
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> acceptance
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//acceptance<span class="token punctuation">:</span><span class="token number">8080</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/financialManagements/**
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> oauth
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//oauth<span class="token punctuation">:</span><span class="token number">8080</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/oauth/**
      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span>
        <span class="token key atrule">corsConfigurations</span><span class="token punctuation">:</span>
          '<span class="token punctuation">[</span>/**<span class="token punctuation">]</span>'<span class="token punctuation">:</span>
            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"*"</span>
            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"*"</span>
            <span class="token key atrule">allowedHeaders</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token string">"*"</span>
            <span class="token key atrule">allowCredentials</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span></code></pre>
<h3 id="·-oauth-인증-적용"><a href="#%C2%B7-oauth-%EC%9D%B8%EC%A6%9D-%EC%A0%81%EC%9A%A9" aria-hidden="true"><span class="icon icon-link"></span></a>· Oauth 인증 적용.</h3>
<ul>
<li>Oauth 인증 적용. </li>
<li>But, 수업 중에 사용한 Oauth 프로젝트를 그대로 이용하여 Gateway에 붙이기만 함.</li>
</ul>
<h2 id="운영"><a href="#%EC%9A%B4%EC%98%81" aria-hidden="true"><span class="icon icon-link"></span></a>운영</h2>
<h3 id="·-cicd-설정"><a href="#%C2%B7-cicd-%EC%84%A4%EC%A0%95" aria-hidden="true"><span class="icon icon-link"></span></a>· CI/CD 설정</h3>
<p>각 구현체들은 각자의 Git을 통해 빌드되며, Git Master에 트리거 되어 있다. pipeline build script 는 각 프로젝트 폴더 이하에 azure_pipeline.yml 에 포함되었다.</p>
<p>azure_pipelist.yml 참고</p>
<p>kubernetes Service</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">trigger</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> master

<span class="token key atrule">resources</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">repo</span><span class="token punctuation">:</span> self

<span class="token key atrule">variables</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> common<span class="token punctuation">-</span>value
  <span class="token comment"># containerRegistry: 'event.azurecr.io'</span>
  <span class="token comment"># containerRegistryDockerConnection: 'acr'</span>
  <span class="token comment"># environment: 'aks.default'</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> imageRepository
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'order'</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockerfilePath
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'**/Dockerfile'</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tag
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'$(Build.BuildId)'</span>
  <span class="token comment"># Agent VM image name</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vmImageName
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'ubuntu-latest'</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MAVEN_CACHE_FOLDER
  <span class="token key atrule">value</span><span class="token punctuation">:</span> $(Pipeline.Workspace)/.m2/repository
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MAVEN_OPTS
  <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'</span>


<span class="token key atrule">stages</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">stage</span><span class="token punctuation">:</span> Build
  <span class="token key atrule">displayName</span><span class="token punctuation">:</span> Build stage
  <span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job</span><span class="token punctuation">:</span> Build
    <span class="token key atrule">displayName</span><span class="token punctuation">:</span> Build
    <span class="token key atrule">pool</span><span class="token punctuation">:</span>
      <span class="token key atrule">vmImage</span><span class="token punctuation">:</span> $(vmImageName)
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> CacheBeta@1
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">'maven | "$(Agent.OS)" | **/pom.xml'</span>
        <span class="token key atrule">restoreKeys</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
           maven | "$(Agent.OS)"
           maven</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> $(MAVEN_CACHE_FOLDER)
      <span class="token key atrule">displayName</span><span class="token punctuation">:</span> Cache Maven local repo
    <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> Maven@3
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token key atrule">mavenPomFile</span><span class="token punctuation">:</span> <span class="token string">'pom.xml'</span>
        <span class="token key atrule">options</span><span class="token punctuation">:</span> <span class="token string">'-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'</span>
        <span class="token key atrule">javaHomeOption</span><span class="token punctuation">:</span> <span class="token string">'JDKVersion'</span>
        <span class="token key atrule">jdkVersionOption</span><span class="token punctuation">:</span> <span class="token string">'1.8'</span>
        <span class="token key atrule">jdkArchitectureOption</span><span class="token punctuation">:</span> <span class="token string">'x64'</span>
        <span class="token key atrule">goals</span><span class="token punctuation">:</span> <span class="token string">'package'</span>
    <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> Docker@2
      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
        <span class="token key atrule">containerRegistry</span><span class="token punctuation">:</span> $(containerRegistryDockerConnection)
        <span class="token key atrule">repository</span><span class="token punctuation">:</span> $(imageRepository)
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'buildAndPush'</span>
        <span class="token key atrule">Dockerfile</span><span class="token punctuation">:</span> <span class="token string">'**/Dockerfile'</span>
        <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          $(tag)</span>

<span class="token punctuation">-</span> <span class="token key atrule">stage</span><span class="token punctuation">:</span> Deploy
  <span class="token key atrule">displayName</span><span class="token punctuation">:</span> Deploy stage
  <span class="token key atrule">dependsOn</span><span class="token punctuation">:</span> Build

  <span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">deployment</span><span class="token punctuation">:</span> Deploy
    <span class="token key atrule">displayName</span><span class="token punctuation">:</span> Deploy
    <span class="token key atrule">pool</span><span class="token punctuation">:</span>
      <span class="token key atrule">vmImage</span><span class="token punctuation">:</span> $(vmImageName)
    <span class="token key atrule">environment</span><span class="token punctuation">:</span> $(environment)
    <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
      <span class="token key atrule">runOnce</span><span class="token punctuation">:</span>
        <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
          <span class="token key atrule">steps</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> Kubernetes@1
            <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
              <span class="token key atrule">connectionType</span><span class="token punctuation">:</span> <span class="token string">'Kubernetes Service Connection'</span>
              <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">'default'</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'apply'</span>
              <span class="token key atrule">useConfigurationFile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
              <span class="token key atrule">configurationType</span><span class="token punctuation">:</span> <span class="token string">'inline'</span>
              <span class="token key atrule">inline</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
                apiVersion: apps/v1
                kind: Deployment
                metadata:
                  name: $(imageRepository)
                  labels:
                    app: $(imageRepository)
                spec:
                  replicas: 1
                  selector:
                    matchLabels:
                      app: $(imageRepository)
                  template:
                    metadata:
                      labels:
                        app: $(imageRepository)
                    spec:
                      containers:
                        - name: $(imageRepository)
                          image: $(containerRegistry)/$(imageRepository):$(tag)
                          ports:
                            - containerPort: 8080
                          readinessProbe:
                            httpGet:
                              path: /actuator/health
                              port: 8080
                            initialDelaySeconds: 10
                            timeoutSeconds: 2
                            periodSeconds: 5
                            failureThreshold: 10
                          livenessProbe:
                            httpGet:
                              path: /actuator/health
                              port: 8080
                            initialDelaySeconds: 120
                            timeoutSeconds: 2
                            periodSeconds: 5
                            failureThreshold: 5</span>
              <span class="token key atrule">secretType</span><span class="token punctuation">:</span> <span class="token string">'dockerRegistry'</span>
              <span class="token key atrule">containerRegistryType</span><span class="token punctuation">:</span> <span class="token string">'Azure Container Registry'</span>
          <span class="token punctuation">-</span> <span class="token key atrule">task</span><span class="token punctuation">:</span> Kubernetes@1
            <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
              <span class="token key atrule">connectionType</span><span class="token punctuation">:</span> <span class="token string">'Kubernetes Service Connection'</span>
              <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">'default'</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">'apply'</span>
              <span class="token key atrule">useConfigurationFile</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
              <span class="token key atrule">configurationType</span><span class="token punctuation">:</span> <span class="token string">'inline'</span>
              <span class="token key atrule">inline</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
                apiVersion: v1
                kind: Service
                metadata:
                  name: $(imageRepository)
                  labels:
                    app: $(imageRepository)
                spec:
                  ports:
                    - port: 8080
                      targetPort: 8080
                  selector:
                    app: $(imageRepository)</span>
              <span class="token key atrule">secretType</span><span class="token punctuation">:</span> <span class="token string">'dockerRegistry'</span>
              <span class="token key atrule">containerRegistryType</span><span class="token punctuation">:</span> <span class="token string">'Azure Container Registry'</span></code></pre>
<h3 id="·-동기식-호출--서킷-브레이킹--장애격리"><a href="#%C2%B7-%EB%8F%99%EA%B8%B0%EC%8B%9D-%ED%98%B8%EC%B6%9C--%EC%84%9C%ED%82%B7-%EB%B8%8C%EB%A0%88%EC%9D%B4%ED%82%B9--%EC%9E%A5%EC%95%A0%EA%B2%A9%EB%A6%AC" aria-hidden="true"><span class="icon icon-link"></span></a>· 동기식 호출 / 서킷 브레이킹 / 장애격리</h3>
<ul>
<li>서킷 브레이킹 프레임워크의 선택: Spring FeignClient + Hystrix 옵션을 사용하여 구현함</li>
</ul>
<p>시나리오는 예약 시스템(reservation)-->진료(diagnosis) 시의 연결을 RESTful Request/Response 로 연동하여 구현이 되어있고, 진료 요청이 과도할 경우 CB 를 통하여 장애격리.</p>
<ul>
<li>Hystrix 를 설정:  요청처리 쓰레드에서 처리시간이 610 밀리가 넘어서기 시작하여 어느정도 유지되면 CB 회로가 닫히도록 (요청을 빠르게 실패처리, 차단) 설정</li>
</ul>
<pre class="language-text"><code class="language-text"># application.yml

server:
  port: 8081
spring:
  profiles: default
  cloud:
    stream:
      kafka:
        binder:
          brokers: localhost:9092
      bindings:
        output:
          destination: animal
          contentType: application/json
feign:
  hystrix:
    enabled: true
    
    </code></pre>
<ul>
<li>피호출 서비스(진료:diagnosis) 의 임의 부하 처리 - 400 밀리에서 증감 220 밀리 정도 왔다갔다 하게</li>
</ul>
<pre class="language-text"><code class="language-text"># (diagnosis) MedicalRecord.java (Entity)

    @PrePersist
    public void onPrePersist(){  //진료이력을 저장한 후 적당한 시간 끌기
        ...
        
        try {
            Thread.currentThread().sleep((long) (400 + Math.random() * 220));
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }</code></pre>
<ul>
<li>부하테스터 siege 툴을 통한 서킷 브레이커 동작 확인:</li>
</ul>
<ul>
<li>동시사용자 100명</li>
<li>60초 동안 실시</li>
</ul>
<pre class="language-text"><code class="language-text">$ siege -c100 -t60s -r10 --content-type &quot;application/json&quot; &#39;http://localhost:8081/reservations POST {&quot;reservatorName&quot;: &quot;Jackson&quot;, &quot;phoneNumber&quot;: &quot;01032713104&quot;, &quot;reservationDate&quot;: &quot;2020-05-01&quot;}&#39;

Windows 안에서 작동하는 Ubuntu에서 siege 실행시 &quot;[error] unable to set close control sock.c:141: Invalid argument&quot; 이 발생하여 중간 과정은 알 수 없음.

그러나 아래와 같은 결과를 확인.

Lifting the server siege...
Transactions:                   1067 hits
Availability:                  78.92 %
Elapsed time:                  59.46 secs
Data transferred:               0.37 MB
Response time:                  5.36 secs
Transaction rate:              17.94 trans/sec
Throughput:                     0.01 MB/sec
Concurrency:                   96.13
Successful transactions:        1067
Failed transactions:             285
Longest transaction:            7.01
Shortest transaction:           0.02</code></pre>
<ul>
<li>운영시스템은 죽지 않고 지속적으로 CB 에 의하여 적절히 회로가 열림과 닫힘이 벌어지면서 자원을 보호하고 있음을 보여줌. 78.92% 가 성공.</li>
</ul>
<h3 id="·-오토스케일-아웃"><a href="#%C2%B7-%EC%98%A4%ED%86%A0%EC%8A%A4%EC%BC%80%EC%9D%BC-%EC%95%84%EC%9B%83" aria-hidden="true"><span class="icon icon-link"></span></a>· 오토스케일 아웃</h3>
<p>앞서 CB 는 시스템을 안정되게 운영할 수 있게 해줬지만 사용자의 요청을 100% 받아들여주지 못했기 때문에 이에 대한 보완책으로 자동화된 확장 기능을 적용하고자 한다. </p>
<ul>
<li>진료서비스에 대한 replica 를 동적으로 늘려주도록 HPA 를 설정한다. 설정은 CPU 사용량이 15프로를 넘어서면 replica 를 10개까지 늘려준다:</li>
</ul>
<pre class="language-text"><code class="language-text">kubectl autoscale deploy diagnosis --min=1 --max=10 --cpu-percent=15</code></pre>
<h3 id="·-무정지-재배포"><a href="#%C2%B7-%EB%AC%B4%EC%A0%95%EC%A7%80-%EC%9E%AC%EB%B0%B0%ED%8F%AC" aria-hidden="true"><span class="icon icon-link"></span></a>· 무정지 재배포</h3>
<ul>
<li>모든 프로젝트의 readiness probe 및 liveness probe 설정 완료.</li>
</ul>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
  <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /actuator/health
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">10</span>
<span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
  <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
     <span class="token key atrule">path</span><span class="token punctuation">:</span> /actuator/health
     <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">120</span>
  <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">5</span></code></pre>
</div><div class="mt-8 pt-8 lg:mt-12 lg:pt-12 border-t border-ui-border"><div><div class="flex flex-col sm:flex-row justify-between items-center"><!----><!----></div></div></div></div></div></div></main></div><!----></div>
    <script src="/assets/js/app.cced8b4b.js" defer></script><script src="/assets/js/page--src--templates--markdown-page-vue.edfc8e12.js" defer></script>
  </body>
</html>
